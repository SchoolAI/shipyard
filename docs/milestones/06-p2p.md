# Milestone 6: P2P Remote Collaboration

**Status**: ✅ Complete
**Goal**: Multiple remote reviewers can collaborate via WebRTC

---

## Overview

Add peer-to-peer sync so that:
1. Remote reviewers can join via shared URL
2. All reviewers see each other's annotations in real-time
3. Works without central server (after initial sync)

---

## Deliverables

### 6a: WebRTC Provider

- [x] Add `y-webrtc` provider to browser
- [x] Configure STUN servers (Google's free servers)
- [x] Configure signaling server (`wss://signaling.yjs.dev`)

### 6b: Multi-Provider Setup

Browser now has THREE Yjs providers:
1. y-websocket → MCP server (localhost)
2. y-indexeddb → local persistence
3. y-webrtc → remote peers

**All providers sync the same Y.Doc automatically!**

```typescript
import * as Y from 'yjs';
import { WebsocketProvider } from 'y-websocket';
import { IndexeddbPersistence } from 'y-indexeddb';
import { WebrtcProvider } from 'y-webrtc';

function usePlanWithP2P(planId: string) {
  const [ydoc] = useState(() => new Y.Doc());

  useEffect(() => {
    // 1. WebSocket to MCP server
    const wsProvider = new WebsocketProvider(
      `ws://localhost:${WS_PORT}`,
      planId,
      ydoc
    );

    // 2. IndexedDB persistence
    const indexeddbProvider = new IndexeddbPersistence(planId, ydoc);

    // 3. WebRTC for P2P with remote reviewers
    const webrtcProvider = new WebrtcProvider(planId, ydoc, {
      signaling: ['wss://signaling.yjs.dev'],
      password: null, // Public room
    });

    return () => {
      wsProvider.destroy();
      indexeddbProvider.destroy();
      webrtcProvider.destroy();
    };
  }, [planId, ydoc]);

  return ydoc;
}
```

### 6c: Peer Presence

- [x] Show who's currently viewing the plan
- [ ] Display peer cursors/focus (optional - handled by BlockNote)
- [x] "X reviewers online" indicator

### 6d: Offline/Online Handling

- [x] Graceful degradation when peers offline
- [x] Sync catchup when peer comes online
- [x] Handle MCP server going offline (P2P continues)

---

## Demo Checkpoint

**Scenario**: Multiple reviewers collaborate remotely

```
1. Agent creates plan, opens in browser A
2. Agent shares URL with remote reviewer
3. Reviewer opens in browser B (different network)
4. Both browsers show each other as "online"
5. Reviewer B adds annotation
6. Browser A sees it immediately (via WebRTC, not via MCP server)
7. Agent (via MCP) also sees it (via WebSocket to browser A)
```

---

## Success Criteria

1. Two browsers on different networks can sync
2. Annotations appear in < 1 second
3. Works even if MCP server is stopped (P2P direct)
4. Presence shows who's online

---

## Technical Notes

### WebRTC Configuration

```typescript
import { WebrtcProvider } from 'y-webrtc';
import * as Y from 'yjs';

// WebRTC provider with multiple signaling servers for redundancy
const webrtcProvider = new WebrtcProvider(
  planId, // Room name (plan ID)
  ydoc,
  {
    signaling: [
      'wss://signaling.yjs.dev',
      'wss://y-webrtc-signaling-us.herokuapp.com',
      'wss://y-webrtc-signaling-eu.herokuapp.com',
    ],
    password: null, // Public room (or use password for private)
    // Custom ICE servers (optional, defaults to public STUN)
    peerOpts: {
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' },
          { urls: 'stun:stun2.l.google.com:19302' },
        ],
      },
    },
  }
);
```

### Presence with Yjs Awareness

```typescript
import type { Awareness } from 'y-protocols/awareness';

// WebrtcProvider includes awareness automatically
const awareness: Awareness = webrtcProvider.awareness;

// Set your presence
awareness.setLocalState({
  user: {
    name: userName,
    color: userColor,
  },
  cursor: {
    blockId: focusedBlockId,
  },
});

// Read others' presence
awareness.on('change', () => {
  const states = awareness.getStates();
  states.forEach((state, clientId) => {
    if (clientId !== awareness.clientID) {
      // Show peer cursor/name
    }
  });
});
```

### Sync Topology

```
                                   Y.Doc (planId)
                                         │
           ┌─────────────────────────────┼─────────────────────────┐
           │                             │                         │
           │                             │                         │
    y-websocket              y-indexeddb (persistence)      y-webrtc (P2P)
           │                             │                         │
           ▼                             ▼                         ▼
    ┌─────────────┐              ┌──────────────┐         ┌─────────────┐
    │ MCP Server  │              │ Browser      │◄───────►│ Remote Peer │
    │ (localhost) │              │ Storage      │         │ Browser     │
    └─────────────┘              └──────────────┘         └─────────────┘
```

**Key insight:** All three providers share the same Y.Doc. Changes from any provider propagate to all others automatically.

If MCP server goes offline:
- Browser A ↔ Browser B still sync via y-webrtc
- Both have y-indexeddb persistence
- When MCP comes back, y-websocket reconnects and syncs

---

## Dependencies

- Milestone 4 (Review Flow) - need something to collaborate on

## Blocks

- Nothing (this is the final feature milestone)

---

*Created: 2026-01-02*
