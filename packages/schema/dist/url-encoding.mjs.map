{"version":3,"file":"url-encoding.mjs","names":[],"sources":["../src/url-encoding.ts"],"sourcesContent":["import type { Block } from '@blocknote/core';\nimport lzstring from 'lz-string';\nimport type { Artifact, Deliverable, PlanMetadata, PlanSnapshot } from './plan.js';\n\n/**\n * Lightweight snapshot reference for URL encoding.\n * Contains metadata only - full content is in keyVersions or the live Y.Doc.\n */\nexport interface UrlSnapshotRef {\n  id: string;\n  status: PlanMetadata['status'];\n  createdBy: string;\n  reason: string;\n  createdAt: number;\n  /** Thread summary (lightweight) */\n  threads?: { total: number; unresolved: number };\n}\n\n/**\n * Key version with full content.\n * Used for significant versions (initial, approval, completion).\n */\nexport interface UrlKeyVersion {\n  id: string;\n  content: Block[];\n}\n\n/**\n * URL-encoded plan structure v1 (legacy).\n * This is a snapshot of the plan state that can be shared via URL.\n */\nexport interface UrlEncodedPlanV1 {\n  v: 1;\n  id: string;\n  title: string;\n  /** Status uses the same union type as PlanMetadata for type safety */\n  status: PlanMetadata['status'];\n  repo?: string;\n  pr?: number;\n  content: Block[];\n  artifacts?: Artifact[];\n  /** Deliverables with linkage info (which artifact fulfills each deliverable) */\n  deliverables?: Deliverable[];\n  comments?: unknown[];\n}\n\n/**\n * URL-encoded plan structure v2 with version history.\n * Includes lightweight refs for all versions + full content for key versions.\n */\nexport interface UrlEncodedPlanV2 {\n  v: 2;\n  id: string;\n  title: string;\n  /** Current status */\n  status: PlanMetadata['status'];\n  repo?: string;\n  pr?: number;\n  /** Current content (the latest version) */\n  content: Block[];\n  artifacts?: Artifact[];\n  /** Deliverables with linkage info */\n  deliverables?: Deliverable[];\n  comments?: unknown[];\n\n  /** Version history metadata (lightweight refs, not full content) */\n  versionRefs?: UrlSnapshotRef[];\n\n  /**\n   * Full snapshots for key versions only (e.g., initial + approval + final).\n   * To limit URL size, we store at most 3 full snapshots.\n   */\n  keyVersions?: UrlKeyVersion[];\n}\n\n/**\n * Union type for all URL-encoded plan versions.\n * Use type guards to distinguish between versions.\n */\nexport type UrlEncodedPlan = UrlEncodedPlanV1 | UrlEncodedPlanV2;\n\n/**\n * Type guard for v1 plans.\n */\nexport function isUrlEncodedPlanV1(plan: UrlEncodedPlan): plan is UrlEncodedPlanV1 {\n  return plan.v === 1;\n}\n\n/**\n * Type guard for v2 plans with version history.\n */\nexport function isUrlEncodedPlanV2(plan: UrlEncodedPlan): plan is UrlEncodedPlanV2 {\n  return plan.v === 2;\n}\n\n/**\n * Encodes a plan to a URL-safe compressed string.\n *\n * Uses lz-string compression + URI encoding for maximum compatibility.\n * Typical compression: 40-60% reduction.\n */\nexport function encodePlan(plan: UrlEncodedPlan): string {\n  const json = JSON.stringify(plan);\n  return lzstring.compressToEncodedURIComponent(json);\n}\n\n/**\n * Decodes a URL-encoded plan string.\n * Supports both v1 and v2 plan formats.\n *\n * Returns null if decoding fails or data is corrupted.\n */\nexport function decodePlan(encoded: string): UrlEncodedPlan | null {\n  try {\n    const json = lzstring.decompressFromEncodedURIComponent(encoded);\n    if (!json) return null;\n\n    const parsed = JSON.parse(json) as { v?: number };\n\n    return parsed as UrlEncodedPlan;\n  } catch (_error) {\n    return null;\n  }\n}\n\n/**\n * Creates a complete plan URL from a plan object.\n *\n * @param baseUrl - Base URL for the app (e.g., \"https://org.github.io/shipyard\")\n * @param plan - Plan object to encode\n * @returns Complete URL with encoded plan\n */\nexport function createPlanUrl(baseUrl: string, plan: UrlEncodedPlan): string {\n  const encoded = encodePlan(plan);\n  const url = new URL(baseUrl);\n  url.searchParams.set('d', encoded);\n  return url.toString();\n}\n\n/**\n * Select key versions for URL encoding.\n * Returns IDs of significant versions: first, first approval, and latest.\n * Maximum 3 versions to limit URL size.\n */\nfunction selectKeyVersionIds(snapshots: PlanSnapshot[]): string[] {\n  if (snapshots.length === 0) return [];\n  if (snapshots.length <= 3) return snapshots.map((s) => s.id);\n\n  const ids: string[] = [];\n\n  const first = snapshots[0];\n  if (first) ids.push(first.id);\n\n  const firstApproval = snapshots.find((s) => s.status === 'in_progress');\n  if (firstApproval && !ids.includes(firstApproval.id)) {\n    ids.push(firstApproval.id);\n  }\n\n  const last = snapshots[snapshots.length - 1];\n  if (last && !ids.includes(last.id)) {\n    ids.push(last.id);\n  }\n\n  return ids;\n}\n\n/**\n * Creates a plan URL with version history included.\n * Optimizes size by storing:\n * - Current state (full content)\n * - Version refs (lightweight metadata) for all versions\n * - Key versions (full content) for 2-3 significant versions\n *\n * @param baseUrl - Base URL for the app\n * @param plan - Base plan data (without version info)\n * @param snapshots - All snapshots from Y.Doc\n * @returns Complete URL with version history\n */\nexport function createPlanUrlWithHistory(\n  baseUrl: string,\n  plan: Omit<UrlEncodedPlanV2, 'v' | 'versionRefs' | 'keyVersions'>,\n  snapshots: PlanSnapshot[]\n): string {\n  const versionRefs: UrlSnapshotRef[] = snapshots.map((s) => ({\n    id: s.id,\n    status: s.status,\n    createdBy: s.createdBy,\n    reason: s.reason,\n    createdAt: s.createdAt,\n    threads: s.threadSummary,\n  }));\n\n  const keyVersionIds = selectKeyVersionIds(snapshots);\n  const keyVersions: UrlKeyVersion[] = snapshots\n    .filter((s) => keyVersionIds.includes(s.id))\n    .map((s) => ({\n      id: s.id,\n      content: s.content as Block[],\n    }));\n\n  const urlPlan: UrlEncodedPlanV2 = {\n    v: 2,\n    ...plan,\n    versionRefs: versionRefs.length > 0 ? versionRefs : undefined,\n    keyVersions: keyVersions.length > 0 ? keyVersions : undefined,\n  };\n\n  return createPlanUrl(baseUrl, urlPlan);\n}\n\n/**\n * Extracts and decodes plan from current URL.\n *\n * @returns Decoded plan or null if not found/invalid\n */\nexport function getPlanFromUrl(): UrlEncodedPlan | null {\n  if (typeof globalThis !== 'undefined' && 'location' in globalThis) {\n    const location = (globalThis as typeof globalThis & { location: { search: string } }).location;\n    const params = new URLSearchParams(location.search);\n    const encoded = params.get('d');\n    if (!encoded) return null;\n\n    return decodePlan(encoded);\n  }\n\n  return null;\n}\n"],"mappings":";;;;;;AAoFA,SAAgB,mBAAmB,MAAgD;AACjF,QAAO,KAAK,MAAM;;;;;AAMpB,SAAgB,mBAAmB,MAAgD;AACjF,QAAO,KAAK,MAAM;;;;;;;;AASpB,SAAgB,WAAW,MAA8B;CACvD,MAAM,OAAO,KAAK,UAAU,KAAK;AACjC,QAAO,SAAS,8BAA8B,KAAK;;;;;;;;AASrD,SAAgB,WAAW,SAAwC;AACjE,KAAI;EACF,MAAM,OAAO,SAAS,kCAAkC,QAAQ;AAChE,MAAI,CAAC,KAAM,QAAO;AAIlB,SAFe,KAAK,MAAM,KAAK;UAGxB,QAAQ;AACf,SAAO;;;;;;;;;;AAWX,SAAgB,cAAc,SAAiB,MAA8B;CAC3E,MAAM,UAAU,WAAW,KAAK;CAChC,MAAM,MAAM,IAAI,IAAI,QAAQ;AAC5B,KAAI,aAAa,IAAI,KAAK,QAAQ;AAClC,QAAO,IAAI,UAAU;;;;;;;AAQvB,SAAS,oBAAoB,WAAqC;AAChE,KAAI,UAAU,WAAW,EAAG,QAAO,EAAE;AACrC,KAAI,UAAU,UAAU,EAAG,QAAO,UAAU,KAAK,MAAM,EAAE,GAAG;CAE5D,MAAM,MAAgB,EAAE;CAExB,MAAM,QAAQ,UAAU;AACxB,KAAI,MAAO,KAAI,KAAK,MAAM,GAAG;CAE7B,MAAM,gBAAgB,UAAU,MAAM,MAAM,EAAE,WAAW,cAAc;AACvE,KAAI,iBAAiB,CAAC,IAAI,SAAS,cAAc,GAAG,CAClD,KAAI,KAAK,cAAc,GAAG;CAG5B,MAAM,OAAO,UAAU,UAAU,SAAS;AAC1C,KAAI,QAAQ,CAAC,IAAI,SAAS,KAAK,GAAG,CAChC,KAAI,KAAK,KAAK,GAAG;AAGnB,QAAO;;;;;;;;;;;;;;AAeT,SAAgB,yBACd,SACA,MACA,WACQ;CACR,MAAM,cAAgC,UAAU,KAAK,OAAO;EAC1D,IAAI,EAAE;EACN,QAAQ,EAAE;EACV,WAAW,EAAE;EACb,QAAQ,EAAE;EACV,WAAW,EAAE;EACb,SAAS,EAAE;EACZ,EAAE;CAEH,MAAM,gBAAgB,oBAAoB,UAAU;CACpD,MAAM,cAA+B,UAClC,QAAQ,MAAM,cAAc,SAAS,EAAE,GAAG,CAAC,CAC3C,KAAK,OAAO;EACX,IAAI,EAAE;EACN,SAAS,EAAE;EACZ,EAAE;AASL,QAAO,cAAc,SAPa;EAChC,GAAG;EACH,GAAG;EACH,aAAa,YAAY,SAAS,IAAI,cAAc;EACpD,aAAa,YAAY,SAAS,IAAI,cAAc;EACrD,CAEqC;;;;;;;AAQxC,SAAgB,iBAAwC;AACtD,KAAI,OAAO,eAAe,eAAe,cAAc,YAAY;EACjE,MAAM,WAAY,WAAoE;EAEtF,MAAM,UADS,IAAI,gBAAgB,SAAS,OAAO,CAC5B,IAAI,IAAI;AAC/B,MAAI,CAAC,QAAS,QAAO;AAErB,SAAO,WAAW,QAAQ;;AAG5B,QAAO"}