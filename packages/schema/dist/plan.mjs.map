{"version":3,"file":"plan.mjs","names":[],"sources":["../src/plan.ts"],"sourcesContent":["import { nanoid } from 'nanoid';\nimport { z } from 'zod';\n\n/**\n * Valid status values for a plan.\n *\n * Flow: draft → pending_review ⟷ changes_requested (loop) → in_progress → completed\n *\n * When reviewer approves: pending_review → in_progress (with matching reviewRequestId)\n * When reviewer requests changes: pending_review → changes_requested (with matching reviewRequestId)\n * Agent fixes and re-submits: changes_requested → pending_review (new reviewRequestId)\n */\nexport const PlanStatusValues = [\n  'draft',\n  'pending_review',\n  'changes_requested',\n  'in_progress',\n  'completed',\n] as const;\nexport type PlanStatusType = (typeof PlanStatusValues)[number];\n\n/**\n * Valid tab/view types for plan content display.\n * Used for tab navigation in PlanContent component and URL routing.\n */\nexport const PlanViewTabValues = ['plan', 'activity', 'deliverables', 'changes'] as const;\nexport type PlanViewTab = (typeof PlanViewTabValues)[number];\n\n/**\n * Supported origin platforms for conversation export.\n * Used to identify where a plan/conversation originated.\n */\nexport const OriginPlatformValues = [\n  'claude-code',\n  'devin',\n  'cursor',\n  'windsurf',\n  'aider',\n  'unknown',\n] as const;\nexport type OriginPlatform = (typeof OriginPlatformValues)[number];\n\n/**\n * Origin metadata for conversation export - discriminated by platform.\n * Each platform has different session tracking mechanisms.\n */\nexport const ClaudeCodeOriginMetadataSchema = z.object({\n  platform: z.literal('claude-code'),\n  sessionId: z.string(),\n  transcriptPath: z.string(),\n  cwd: z.string().optional(),\n});\n\nexport const DevinOriginMetadataSchema = z.object({\n  platform: z.literal('devin'),\n  sessionId: z.string(),\n});\n\nexport const CursorOriginMetadataSchema = z.object({\n  platform: z.literal('cursor'),\n  conversationId: z.string(),\n  generationId: z.string().optional(),\n});\n\nexport const UnknownOriginMetadataSchema = z.object({\n  platform: z.literal('unknown'),\n});\n\nexport const OriginMetadataSchema = z.discriminatedUnion('platform', [\n  ClaudeCodeOriginMetadataSchema,\n  DevinOriginMetadataSchema,\n  CursorOriginMetadataSchema,\n  UnknownOriginMetadataSchema,\n]);\n\nexport type OriginMetadata = z.infer<typeof OriginMetadataSchema>;\nexport type ClaudeCodeOriginMetadata = z.infer<typeof ClaudeCodeOriginMetadataSchema>;\nexport type DevinOriginMetadata = z.infer<typeof DevinOriginMetadataSchema>;\nexport type CursorOriginMetadata = z.infer<typeof CursorOriginMetadataSchema>;\n\n/**\n * Parse and validate Claude Code hook metadata.\n * Safely extracts origin fields with runtime validation.\n */\nexport function parseClaudeCodeOrigin(\n  hookMetadata: Record<string, unknown> | undefined\n): ClaudeCodeOriginMetadata | null {\n  if (!hookMetadata) return null;\n\n  const result = ClaudeCodeOriginMetadataSchema.safeParse({\n    platform: 'claude-code',\n    sessionId: hookMetadata.originSessionId,\n    transcriptPath: hookMetadata.originTranscriptPath,\n    cwd: hookMetadata.originCwd,\n  });\n\n  return result.success ? result.data : null;\n}\n\n/**\n * A conversation version tracked on the plan.\n * Content is NOT stored in CRDT - only metadata for provenance tracking.\n * Actual content is transferred on-demand via P2P during handoff.\n */\ninterface ConversationVersionBase {\n  versionId: string;\n  creator: string;\n  platform: OriginPlatform;\n  /** Foreign key to local file - content NOT stored in CRDT */\n  sessionId: string;\n  messageCount: number;\n  createdAt: number;\n}\n\nexport type ConversationVersion =\n  | (ConversationVersionBase & { handedOff: false })\n  | (ConversationVersionBase & { handedOff: true; handedOffAt: number; handedOffTo: string });\n\nconst ConversationVersionBaseSchema = z.object({\n  versionId: z.string(),\n  creator: z.string(),\n  platform: z.enum(OriginPlatformValues),\n  sessionId: z.string(),\n  messageCount: z.number(),\n  createdAt: z.number(),\n});\n\nexport const ConversationVersionSchema = z.discriminatedUnion('handedOff', [\n  ConversationVersionBaseSchema.extend({\n    handedOff: z.literal(false),\n  }),\n  ConversationVersionBaseSchema.extend({\n    handedOff: z.literal(true),\n    handedOffAt: z.number(),\n    handedOffTo: z.string(),\n  }),\n]);\n\nexport const PlanEventTypes = [\n  'plan_created',\n  'status_changed',\n  'comment_added',\n  'comment_resolved',\n  'artifact_uploaded',\n  'deliverable_linked',\n  'pr_linked',\n  'content_edited',\n  'approved',\n  'changes_requested',\n  'completed',\n  'conversation_imported',\n  'conversation_handed_off',\n  'step_completed',\n  'plan_archived',\n  'plan_unarchived',\n  'conversation_exported',\n  'plan_shared',\n  'approval_requested',\n  'input_request_created',\n  'input_request_answered',\n  'input_request_declined',\n  'agent_activity',\n] as const;\nexport type PlanEventType = (typeof PlanEventTypes)[number];\n\n/**\n * Agent activity types for tracking agent work status and updates.\n * Used in agent_activity events to communicate agent state to humans.\n */\nexport const AgentActivityTypes = [\n  'help_request',\n  'help_request_resolved',\n  'blocker',\n  'blocker_resolved',\n] as const;\nexport type AgentActivityType = (typeof AgentActivityTypes)[number];\n\n/** Base fields shared by all plan events */\ninterface PlanEventBase {\n  id: string;\n  actor: string;\n  timestamp: number;\n  /** Whether this event should appear in the user's inbox (requires action) */\n  inboxWorthy?: boolean;\n  /**\n   * Who should see this event in their inbox.\n   * Can be: GitHub username(s), 'owner', 'mentioned', 'shared_recipient'\n   */\n  inboxFor?: string | string[];\n}\n\n/** Discriminated union of all plan event types with type-safe data payloads */\nexport type PlanEvent =\n  | (PlanEventBase & {\n      type: 'plan_created' | 'content_edited' | 'plan_archived' | 'plan_unarchived' | 'plan_shared';\n    })\n  | (PlanEventBase & {\n      type: 'status_changed';\n      data: {\n        fromStatus: PlanStatusType;\n        toStatus: PlanStatusType;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'artifact_uploaded';\n      data: {\n        artifactId: string;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'comment_added';\n      data?: {\n        commentId?: string;\n        prNumber?: number;\n        mentions?: boolean;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'comment_resolved';\n      data?: {\n        commentId?: string;\n        resolvedCount?: number;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'deliverable_linked';\n      data?: {\n        deliverableId?: string;\n        artifactId?: string;\n        allFulfilled?: boolean;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'pr_linked';\n      data: {\n        prNumber: number;\n        url?: string;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'approved' | 'changes_requested';\n      data?: {\n        comment?: string;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'completed';\n    })\n  | (PlanEventBase & {\n      type: 'step_completed';\n      data: {\n        stepId: string;\n        completed: boolean;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'conversation_imported';\n      data: {\n        sourcePlatform?: string;\n        messageCount: number;\n        sourceSessionId?: string;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'conversation_exported';\n      data: {\n        messageCount: number;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'conversation_handed_off';\n      data: {\n        handedOffTo: string;\n        messageCount: number;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'approval_requested';\n      data?: {\n        requesterName?: string;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'input_request_created';\n      data: {\n        requestId: string;\n        requestType: 'text' | 'multiline' | 'choice' | 'confirm';\n        requestMessage: string;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'input_request_answered';\n      data: {\n        requestId: string;\n        response: unknown;\n        answeredBy: string;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'input_request_declined';\n      data: {\n        requestId: string;\n      };\n    })\n  | (PlanEventBase & {\n      type: 'agent_activity';\n      data: AgentActivityData;\n    });\n\n/** Base schema shared by all plan events */\nconst PlanEventBaseSchema = z.object({\n  id: z.string(),\n  actor: z.string(),\n  timestamp: z.number(),\n  inboxWorthy: z.boolean().optional(),\n  inboxFor: z.union([z.string(), z.array(z.string())]).optional(),\n});\n\n/** Zod schema for agent activity data discriminated union */\nexport const AgentActivityDataSchema = z.discriminatedUnion('activityType', [\n  z.object({\n    activityType: z.literal('help_request'),\n    requestId: z.string(),\n    message: z.string(),\n  }),\n  z.object({\n    activityType: z.literal('help_request_resolved'),\n    requestId: z.string(),\n    resolution: z.string().optional(),\n  }),\n  z.object({\n    activityType: z.literal('blocker'),\n    message: z.string(),\n    requestId: z.string(),\n  }),\n  z.object({\n    activityType: z.literal('blocker_resolved'),\n    requestId: z.string(),\n    resolution: z.string().optional(),\n  }),\n]);\n\n/**\n * Discriminated union for agent activity event data.\n * Each activity type has specific required/optional fields.\n * Derived from AgentActivityDataSchema to prevent drift.\n */\nexport type AgentActivityData = z.infer<typeof AgentActivityDataSchema>;\n\n/** Discriminated union schema for plan events */\nexport const PlanEventSchema = z.discriminatedUnion('type', [\n  PlanEventBaseSchema.extend({\n    type: z.enum([\n      'plan_created',\n      'content_edited',\n      'plan_archived',\n      'plan_unarchived',\n      'plan_shared',\n    ]),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('status_changed'),\n    data: z.object({\n      fromStatus: z.enum(PlanStatusValues),\n      toStatus: z.enum(PlanStatusValues),\n    }),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('artifact_uploaded'),\n    data: z.object({\n      artifactId: z.string(),\n    }),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('comment_added'),\n    data: z\n      .object({\n        commentId: z.string().optional(),\n        prNumber: z.number().optional(),\n        mentions: z.boolean().optional(),\n      })\n      .optional(),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('comment_resolved'),\n    data: z\n      .object({\n        commentId: z.string().optional(),\n        resolvedCount: z.number().optional(),\n      })\n      .optional(),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('deliverable_linked'),\n    data: z\n      .object({\n        deliverableId: z.string().optional(),\n        artifactId: z.string().optional(),\n        allFulfilled: z.boolean().optional(),\n      })\n      .optional(),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('pr_linked'),\n    data: z.object({\n      prNumber: z.number(),\n      url: z.string().optional(),\n    }),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.enum(['approved', 'changes_requested']),\n    data: z\n      .object({\n        comment: z.string().optional(),\n      })\n      .optional(),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('completed'),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('step_completed'),\n    data: z.object({\n      stepId: z.string(),\n      completed: z.boolean(),\n    }),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('conversation_imported'),\n    data: z.object({\n      sourcePlatform: z.string().optional(),\n      messageCount: z.number(),\n      sourceSessionId: z.string().optional(),\n    }),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('conversation_exported'),\n    data: z.object({\n      messageCount: z.number(),\n    }),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('conversation_handed_off'),\n    data: z.object({\n      handedOffTo: z.string(),\n      messageCount: z.number(),\n    }),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('approval_requested'),\n    data: z\n      .object({\n        requesterName: z.string().optional(),\n      })\n      .optional(),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('input_request_created'),\n    data: z.object({\n      requestId: z.string(),\n      requestType: z.enum(['text', 'multiline', 'choice', 'confirm']),\n      requestMessage: z.string(),\n    }),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('input_request_answered'),\n    data: z.object({\n      requestId: z.string(),\n      response: z.unknown(),\n      answeredBy: z.string(),\n    }),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('input_request_declined'),\n    data: z.object({\n      requestId: z.string(),\n    }),\n  }),\n  PlanEventBaseSchema.extend({\n    type: z.literal('agent_activity'),\n    data: AgentActivityDataSchema,\n  }),\n]);\n\n/**\n * Check if an event should appear in a user's inbox.\n *\n * @param event - The event to check\n * @param username - GitHub username to check against\n * @param ownerId - Optional plan owner's username (needed to resolve 'owner' in inboxFor)\n * @returns true if the event is inbox-worthy for this user\n */\nexport function isInboxWorthy(event: PlanEvent, username: string, ownerId?: string): boolean {\n  if (!event.inboxWorthy) {\n    return false;\n  }\n\n  if (!event.inboxFor) {\n    return true;\n  }\n\n  const resolvedInboxFor = event.inboxFor === 'owner' && ownerId ? ownerId : event.inboxFor;\n\n  if (Array.isArray(resolvedInboxFor)) {\n    return resolvedInboxFor.includes(username);\n  }\n\n  return resolvedInboxFor === username;\n}\n\n/** Base fields shared by all plan statuses */\ninterface PlanMetadataBase {\n  id: string;\n  title: string;\n  createdAt: number;\n  updatedAt: number;\n  repo?: string;\n  pr?: number;\n  ownerId?: string;\n  /** Defaults to true when ownerId is set */\n  approvalRequired?: boolean;\n  approvedUsers?: string[];\n  /** Users who have been denied access to this plan */\n  rejectedUsers?: string[];\n  /** SHA256 hash of session token for MCP API access */\n  sessionTokenHash?: string;\n  /** When the plan was archived (hidden from sidebar by default) */\n  archivedAt?: number;\n  /** Display name of who archived the plan */\n  archivedBy?: string;\n  /** Origin metadata for conversation export (platform-specific) */\n  origin?: OriginMetadata;\n  /** Records when each user last viewed the plan (username → timestamp) */\n  viewedBy?: Record<string, number>;\n  /**\n   * Conversation versions tracked on this plan.\n   * Content is NOT stored - only metadata for provenance tracking.\n   * Actual content is transferred on-demand via P2P.\n   */\n  conversationVersions?: ConversationVersion[];\n  /** Event log for timeline display and audit trail */\n  events?: PlanEvent[];\n  /** Free-form tags for flexible categorization (e.g., \"ui\", \"bug\", \"project:mobile-app\") */\n  tags?: string[];\n}\n\n/** Discriminated union based on status field */\nexport type PlanMetadata =\n  | (PlanMetadataBase & {\n      status: 'draft';\n    })\n  | (PlanMetadataBase & {\n      status: 'pending_review';\n      /**\n       * Unique identifier for current review request.\n       * Set by hook when requesting review, checked before accepting approval/denial.\n       * Prevents stale review decisions from previous cycles.\n       */\n      reviewRequestId: string;\n    })\n  | (PlanMetadataBase & {\n      status: 'changes_requested';\n      /** When the plan was reviewed (changes requested) */\n      reviewedAt: number;\n      /** Display name of the reviewer */\n      reviewedBy: string;\n      /** Feedback from reviewer about requested changes */\n      reviewComment?: string;\n    })\n  | (PlanMetadataBase & {\n      status: 'in_progress';\n      /** When the plan was approved */\n      reviewedAt: number;\n      /** Display name of the reviewer who approved */\n      reviewedBy: string;\n      /** Optional feedback from reviewer on approval */\n      reviewComment?: string;\n    })\n  | (PlanMetadataBase & {\n      status: 'completed';\n      /** When the task was marked complete */\n      completedAt: number;\n      /** Who marked the task complete (agent or reviewer name) */\n      completedBy: string;\n      /** Snapshot URL generated on completion */\n      snapshotUrl?: string;\n    });\n\n/** Base schema shared by all statuses */\nconst PlanMetadataBaseSchema = z.object({\n  id: z.string(),\n  title: z.string(),\n  createdAt: z.number(),\n  updatedAt: z.number(),\n  repo: z.string().optional(),\n  pr: z.number().optional(),\n  ownerId: z.string().optional(),\n  approvalRequired: z.boolean().optional(),\n  approvedUsers: z.array(z.string()).optional(),\n  rejectedUsers: z.array(z.string()).optional(),\n  sessionTokenHash: z.string().optional(),\n  archivedAt: z.number().optional(),\n  archivedBy: z.string().optional(),\n  origin: OriginMetadataSchema.optional(),\n  viewedBy: z.record(z.string(), z.number()).optional(),\n  conversationVersions: z.array(ConversationVersionSchema).optional(),\n  events: z.array(PlanEventSchema).optional(),\n  tags: z.array(z.string()).optional(),\n});\n\nexport const PlanMetadataSchema = z.discriminatedUnion('status', [\n  PlanMetadataBaseSchema.extend({\n    status: z.literal('draft'),\n  }),\n  PlanMetadataBaseSchema.extend({\n    status: z.literal('pending_review'),\n    reviewRequestId: z.string(),\n  }),\n  PlanMetadataBaseSchema.extend({\n    status: z.literal('changes_requested'),\n    reviewedAt: z.number(),\n    reviewedBy: z.string(),\n    reviewComment: z.string().optional(),\n  }),\n  PlanMetadataBaseSchema.extend({\n    status: z.literal('in_progress'),\n    reviewedAt: z.number(),\n    reviewedBy: z.string(),\n    reviewComment: z.string().optional(),\n  }),\n  PlanMetadataBaseSchema.extend({\n    status: z.literal('completed'),\n    completedAt: z.number(),\n    completedBy: z.string(),\n    snapshotUrl: z.string().optional(),\n  }),\n]);\n\nexport type ArtifactType = 'screenshot' | 'video' | 'test_results' | 'diff';\n\nconst BaseArtifactSchema = z.object({\n  id: z.string(),\n  type: z.enum(['screenshot', 'video', 'test_results', 'diff']),\n  filename: z.string(),\n  description: z.string().optional(),\n  uploadedAt: z.number().optional(),\n});\n\nconst GitHubArtifactSchema = BaseArtifactSchema.extend({\n  storage: z.literal('github'),\n  url: z.string(),\n});\n\nconst LocalArtifactSchema = BaseArtifactSchema.extend({\n  storage: z.literal('local'),\n  localArtifactId: z.string(),\n});\n\nexport const ArtifactSchema = z.discriminatedUnion('storage', [\n  GitHubArtifactSchema,\n  LocalArtifactSchema,\n]);\n\n/**\n * Artifact types - proof-of-work attachments to plans.\n * Can be stored in GitHub (for sharing) or locally (for privacy).\n * Schema is source of truth - types derived via z.infer.\n */\nexport type Artifact = z.infer<typeof ArtifactSchema>;\nexport type GitHubArtifact = z.infer<typeof GitHubArtifactSchema>;\nexport type LocalArtifact = z.infer<typeof LocalArtifactSchema>;\n\nexport function getArtifactUrl(repo: string, pr: number, planId: string, filename: string): string {\n  return `https://raw.githubusercontent.com/${repo}/plan-artifacts/pr-${pr}/${planId}/${filename}`;\n}\n\nexport interface StepCompletion {\n  stepId: string;\n  completed: boolean;\n  completedAt?: number;\n  completedBy?: string;\n}\n\nexport const DeliverableSchema = z.object({\n  id: z.string(),\n  text: z.string(),\n  linkedArtifactId: z.string().optional(),\n  linkedAt: z.number().optional(),\n});\n\n/**\n * A deliverable extracted from plan content.\n * Checkboxes marked with {#deliverable} become deliverables.\n * Schema is source of truth - type derived via z.infer.\n */\nexport type Deliverable = z.infer<typeof DeliverableSchema>;\n\nexport const PlanSnapshotSchema = z.object({\n  id: z.string(),\n  status: z.enum(PlanStatusValues),\n  createdBy: z.string(),\n  reason: z.string(),\n  createdAt: z.number(),\n  content: z.array(z.unknown()),\n  threadSummary: z\n    .object({\n      total: z.number(),\n      unresolved: z.number(),\n    })\n    .optional(),\n  artifacts: z.array(ArtifactSchema).optional(),\n  deliverables: z.array(DeliverableSchema).optional(),\n});\n\n/**\n * A point-in-time snapshot of plan state.\n * Created at significant status transitions for version history.\n * Stored in Y.Array(YDOC_KEYS.SNAPSHOTS) for CRDT sync.\n * Schema is source of truth - type derived via z.infer.\n */\nexport type PlanSnapshot = z.infer<typeof PlanSnapshotSchema>;\n\nexport const LinkedPRStatusValues = ['draft', 'open', 'merged', 'closed'] as const;\nexport type LinkedPRStatus = (typeof LinkedPRStatusValues)[number];\n\nexport const LinkedPRSchema = z.object({\n  prNumber: z.number(),\n  url: z.string(),\n  linkedAt: z.number(),\n  status: z.enum(LinkedPRStatusValues),\n  branch: z.string().optional(),\n  title: z.string().optional(),\n});\n\n/**\n * A GitHub PR linked to a plan.\n * Auto-detected from branch when complete_task runs.\n * Schema is source of truth - type derived via z.infer.\n */\nexport type LinkedPR = z.infer<typeof LinkedPRSchema>;\n\nexport const PRReviewCommentSchema = z.object({\n  id: z.string(),\n  prNumber: z.number(),\n  path: z.string(),\n  line: z.number(),\n  body: z.string(),\n  author: z.string(),\n  createdAt: z.number(),\n  resolved: z.boolean().optional(),\n});\n\n/**\n * A review comment on a PR diff.\n * Can be added by AI (via MCP tool) or human (via UI).\n * Schema is source of truth - type derived via z.infer.\n */\nexport type PRReviewComment = z.infer<typeof PRReviewCommentSchema>;\n\n/**\n * Create a LinkedPR object with validation.\n * Ensures all required fields are present and valid.\n */\nexport function createLinkedPR(params: {\n  prNumber: number;\n  url: string;\n  status: LinkedPRStatus;\n  branch: string;\n  title: string;\n  linkedAt?: number;\n}): LinkedPR {\n  const linkedPR: LinkedPR = {\n    ...params,\n    linkedAt: params.linkedAt ?? Date.now(),\n  };\n\n  return LinkedPRSchema.parse(linkedPR);\n}\n\n/**\n * Create a GitHub artifact with validation.\n * Ensures storage discriminator is set correctly.\n */\nexport function createGitHubArtifact(params: {\n  type: ArtifactType;\n  filename: string;\n  url: string;\n  description?: string;\n  uploadedAt?: number;\n}): GitHubArtifact {\n  const artifact = {\n    id: nanoid(),\n    ...params,\n    storage: 'github' as const,\n    uploadedAt: params.uploadedAt ?? Date.now(),\n  } satisfies GitHubArtifact;\n\n  return ArtifactSchema.parse(artifact) as GitHubArtifact;\n}\n\n/**\n * Create a local artifact with validation.\n * Ensures storage discriminator is set correctly.\n */\nexport function createLocalArtifact(params: {\n  type: ArtifactType;\n  filename: string;\n  localArtifactId: string;\n  description?: string;\n  uploadedAt?: number;\n}): LocalArtifact {\n  const artifact = {\n    id: nanoid(),\n    ...params,\n    storage: 'local' as const,\n    uploadedAt: params.uploadedAt ?? Date.now(),\n  } satisfies LocalArtifact;\n\n  return ArtifactSchema.parse(artifact) as LocalArtifact;\n}\n\n/**\n * Create initial conversation version with handedOff: false.\n * Enforces compile-time type safety for the discriminated union.\n */\nexport function createInitialConversationVersion(params: {\n  versionId: string;\n  creator: string;\n  platform: OriginPlatform;\n  sessionId: string;\n  messageCount: number;\n  createdAt: number;\n}): ConversationVersion {\n  const version = {\n    ...params,\n    handedOff: false as const,\n  };\n\n  return ConversationVersionSchema.parse(version);\n}\n\n/**\n * Create handed-off conversation version.\n * Enforces compile-time type safety for the discriminated union.\n */\nexport function createHandedOffConversationVersion(params: {\n  versionId: string;\n  creator: string;\n  platform: OriginPlatform;\n  sessionId: string;\n  messageCount: number;\n  createdAt: number;\n  handedOffAt: number;\n  handedOffTo: string;\n}): ConversationVersion {\n  const version = {\n    ...params,\n    handedOff: true as const,\n  };\n\n  return ConversationVersionSchema.parse(version);\n}\n"],"mappings":"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"}