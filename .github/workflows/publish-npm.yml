name: Publish to npm

run-name: >-
  ${{ github.event_name == 'schedule'
      && 'Nightly Build'
      || github.event_name == 'workflow_dispatch' && inputs.action == 'promote'
      && format('Promote {0} â†’ {1}', inputs.rc_version, inputs.stable_version)
      || github.event_name == 'workflow_dispatch' && inputs.action == 'rc'
      && 'Publish Release Candidate'
      || github.event_name == 'workflow_dispatch' && inputs.action == 'nightly'
      && 'Manual Nightly Build'
      || 'Publish' }}

concurrency:
  group: publish-npm
  cancel-in-progress: false

on:
  schedule:
    # Nightly at 2:15 AM UTC (off-peak to avoid GitHub contention)
    - cron: '15 2 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'What to publish'
        required: true
        type: choice
        options:
          - nightly       # Publish nightly build (same as scheduled)
          - rc            # Publish release candidate (for testing before stable)
          - promote       # Promote existing version to stable
        default: nightly
      rc_version:
        description: 'Version to promote (only for promote action, e.g., 0.3.2-nightly.20260125)'
        required: false
        type: string
      stable_version:
        description: 'Stable version (only for promote action, e.g., 0.4.0)'
        required: false
        type: string

jobs:
  # Check if there are changes since last nightly/rc (skip empty builds)
  check-changes:
    runs-on: ubuntu-latest
    # Only check for scheduled runs - manual triggers always build
    if: github.event_name == 'schedule'
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes since last nightly/rc
        id: check
        run: |
          # Find the most recent nightly or rc tag
          LAST_PRERELEASE=$(git tag -l 'v*-nightly.*' -l 'v*-rc.*' | sort -V | tail -1)

          if [ -z "$LAST_PRERELEASE" ]; then
            echo "No previous nightly/rc found, will build"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            CHANGES=$(git log "$LAST_PRERELEASE"..HEAD --oneline | wc -l)
            if [ "$CHANGES" -gt 0 ]; then
              echo "Found $CHANGES commits since $LAST_PRERELEASE"
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              echo "No changes since $LAST_PRERELEASE, skipping build"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          fi

  publish:
    runs-on: ubuntu-latest
    # Run if: manual trigger OR (scheduled AND has changes)
    needs: [check-changes]
    if: |
      always() &&
      (github.event_name == 'workflow_dispatch' ||
       (github.event_name == 'schedule' && needs.check-changes.outputs.has_changes == 'true'))
    permissions:
      contents: write   # For creating tags and commits
      id-token: write   # For npm OIDC trusted publishing
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for tags

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          # NOTE: Do NOT set registry-url - conflicts with OIDC

      - name: Install npm 11.5+ for OIDC trusted publishing
        run: npm install -g npm@latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check npm package dependencies
        run: node scripts/check-npm-deps.js

      - name: Build packages
        run: pnpm build --filter @shipyard/schema --filter @shipyard/shared --filter @shipyard/server --filter @shipyard/hook

      # ============================================
      # PROMOTE ACTION: Move existing RC to stable
      # ============================================
      - name: Promote RC to stable
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.action == 'promote' }}
        env:
          # Use env vars to prevent command injection from user inputs
          INPUT_RC_VERSION: ${{ inputs.rc_version }}
          INPUT_STABLE_VERSION: ${{ inputs.stable_version }}
        run: |
          # Trim whitespace from inputs (using env vars, not direct interpolation)
          RC_VERSION=$(echo "$INPUT_RC_VERSION" | xargs)
          STABLE_VERSION=$(echo "$INPUT_STABLE_VERSION" | xargs)

          if [ -z "$RC_VERSION" ] || [ -z "$STABLE_VERSION" ]; then
            echo "::error::Both rc_version and stable_version are required for promote action"
            exit 1
          fi

          # Validate version formats (basic semver check)
          if ! [[ "$RC_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-(nightly|rc)\.[0-9]+$ ]]; then
            echo "::error::Invalid rc_version format. Expected: X.Y.Z-nightly.YYYYMMDD or X.Y.Z-rc.YYYYMMDD"
            exit 1
          fi
          if ! [[ "$STABLE_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid stable_version format. Expected: X.Y.Z"
            exit 1
          fi

          echo "Promoting $RC_VERSION â†’ $STABLE_VERSION"

          # Clean up any previous tarballs
          rm -f schoolai-shipyard-mcp-*.tgz
          rm -rf package/

          # Download the RC tarball
          if ! npm pack "@schoolai/shipyard-mcp@$RC_VERSION"; then
            echo "::error::Failed to download $RC_VERSION from npm. Does it exist?"
            exit 1
          fi
          TARBALL=$(ls -t schoolai-shipyard-mcp-*.tgz | head -1)
          echo "Downloaded: $TARBALL"

          # Extract, update version, repack
          tar -xzf "$TARBALL"
          cd package
          npm version "$STABLE_VERSION" --no-git-tag-version --allow-same-version
          cd ..

          # Re-publish as stable (OIDC works with publish --provenance)
          cd package
          npm publish --access public --provenance --tag latest
          cd ..

          echo "âœ… Published $STABLE_VERSION as latest"

      - name: Update version and create tag (promote)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.action == 'promote' }}
        env:
          INPUT_STABLE_VERSION: ${{ inputs.stable_version }}
        run: |
          STABLE_VERSION=$(echo "$INPUT_STABLE_VERSION" | xargs)

          # Update package-npm.json
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('./package-npm.json', 'utf8'));
            pkg.version = '$STABLE_VERSION';
            fs.writeFileSync('package-npm.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          # Update .claude-plugin/plugin.json (keep plugin version in sync)
          node -e "
            const fs = require('fs');
            const pluginPath = '.claude-plugin/plugin.json';
            const plugin = JSON.parse(fs.readFileSync(pluginPath, 'utf8'));
            plugin.version = '$STABLE_VERSION';
            fs.writeFileSync(pluginPath, JSON.stringify(plugin, null, 2) + '\n');
          "

          # Commit and tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package-npm.json .claude-plugin/plugin.json
          git commit -m "chore: release v$STABLE_VERSION"
          git tag "v$STABLE_VERSION"

          # Pull latest changes before pushing (in case of concurrent commits)
          git pull --rebase origin main
          git push origin main
          git push origin "v$STABLE_VERSION"

          echo "âœ… Created tag v$STABLE_VERSION"

      - name: Create GitHub Release (promote)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.action == 'promote' }}
        uses: actions/github-script@v7
        env:
          INPUT_STABLE_VERSION: ${{ inputs.stable_version }}
          INPUT_RC_VERSION: ${{ inputs.rc_version }}
        with:
          script: |
            const stableVersion = process.env.INPUT_STABLE_VERSION.trim();
            const rcVersion = process.env.INPUT_RC_VERSION.trim();
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${stableVersion}`,
              name: `v${stableVersion}`,
              body: `Promoted from: \`${rcVersion}\`\n\nInstall with:\n\`\`\`bash\nnpm install @schoolai/shipyard-mcp\n# or\nnpx -y -p @schoolai/shipyard-mcp mcp-server-shipyard\n\`\`\``,
              draft: false,
              prerelease: false
            });

      # ============================================
      # PUBLISH ACTION: Build and publish new version
      # ============================================
      - name: Determine version and npm tag
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.action == 'promote') }}
        id: version
        run: |
          BASE_VERSION=$(node -p "require('./package-npm.json').version")
          DATE=$(date -u +%Y%m%d)

          # Determine if this is a nightly or RC build
          if [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ inputs.action }}" == "nightly" ]]; then
            # Nightly build: 0.3.2-nightly.20260125
            VERSION="${BASE_VERSION}-nightly.${DATE}"
            BUILD_TYPE="nightly"
          else
            # Release candidate: 0.3.2-rc.20260125
            VERSION="${BASE_VERSION}-rc.${DATE}"
            BUILD_TYPE="rc"
          fi

          NPM_TAG="next"
          echo "Publishing ${BUILD_TYPE} version: $VERSION â†’ @next"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "npm_tag=$NPM_TAG" >> $GITHUB_OUTPUT
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT

      - name: Prepare npm package
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.action == 'promote') }}
        run: |
          cp package-npm.json package.json
          npm version "${{ steps.version.outputs.version }}" --no-git-tag-version --allow-same-version

      - name: Publish to npm
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.action == 'promote') }}
        run: npm publish --access public --provenance --tag ${{ steps.version.outputs.npm_tag }}

      # ============================================
      # POST-PUBLISH: Tags, comments, and summaries
      # ============================================
      - name: Create git tag for tracking
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.action == 'promote') }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"
          echo "âœ… Created tag v${{ steps.version.outputs.version }}"

      - name: Create GitHub Pre-Release
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.action == 'promote') }}
        uses: actions/github-script@v7
        with:
          script: |
            const buildType = '${{ steps.version.outputs.build_type }}';
            const version = '${{ steps.version.outputs.version }}';
            const isRC = buildType === 'rc';

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${version}`,
              name: isRC ? `Release Candidate ${version}` : `Nightly ${version}`,
              body: `${isRC ? 'ðŸš€ Release Candidate' : 'ðŸŒ™ Nightly Build'}\n\nInstall with:\n\`\`\`bash\nnpm install @schoolai/shipyard-mcp@next\n# or\nnpx -y -p @schoolai/shipyard-mcp@next mcp-server-shipyard\n\`\`\``,
              draft: false,
              prerelease: true
            });

      - name: Summary
        if: always()
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_ACTION: ${{ inputs.action }}
          INPUT_RC_VERSION: ${{ inputs.rc_version }}
          INPUT_STABLE_VERSION: ${{ inputs.stable_version }}
          VERSION: ${{ steps.version.outputs.version }}
          BUILD_TYPE: ${{ steps.version.outputs.build_type }}
          NPM_TAG: ${{ steps.version.outputs.npm_tag }}
        run: |
          echo "## Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "$EVENT_NAME" == "workflow_dispatch" && "$INPUT_ACTION" == "promote" ]]; then
            echo "**Action:** Promoted to stable" >> $GITHUB_STEP_SUMMARY
            echo "- From: \`$INPUT_RC_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "- To: \`$INPUT_STABLE_VERSION\`" >> $GITHUB_STEP_SUMMARY
          elif [[ -n "$VERSION" ]]; then
            echo "**Build Type:** $BUILD_TYPE" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "**npm Tag:** \`@$NPM_TAG\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Install with:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "npm install @schoolai/shipyard-mcp@next" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** Build did not complete version determination" >> $GITHUB_STEP_SUMMARY
          fi
