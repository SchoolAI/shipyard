name: Publish npm

on:
  schedule:
    - cron: '15 6 * * *' # 6:15 AM UTC (midnight MST)
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - rc
          - promote
      promote_version:
        description: 'Version to promote (e.g. 0.8.0-rc.20260221.0). Required for promote.'
        required: false
        type: string

concurrency:
  group: publish-npm
  cancel-in-progress: false

permissions: {}

jobs:
  publish:
    runs-on: ubuntu-latest
    name: Publish @schoolai/shipyard
    permissions:
      contents: write
      id-token: write
    steps:
      # ── Determine release type ──────────────────────────────────────
      - name: Determine release type
        id: release
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_RELEASE_TYPE: ${{ github.event.inputs.release_type }}
        run: |
          if [ "${EVENT_NAME}" = "schedule" ]; then
            echo "type=nightly" >> "$GITHUB_OUTPUT"
          else
            echo "type=${INPUT_RELEASE_TYPE}" >> "$GITHUB_OUTPUT"
          fi

      # ── Validate promote input ──────────────────────────────────────
      - name: Validate promote version
        if: steps.release.outputs.type == 'promote'
        env:
          PROMOTE_VERSION: ${{ github.event.inputs.promote_version }}
        run: |
          if [ -z "${PROMOTE_VERSION}" ]; then
            echo "::error::promote_version is required for promote releases"
            exit 1
          fi
          if ! echo "${PROMOTE_VERSION}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+-(nightly|rc)\.[0-9]{8}(\.[0-9]+)?$'; then
            echo "::error::Invalid version format: ${PROMOTE_VERSION}. Expected: X.Y.Z-(nightly|rc).YYYYMMDD[.N]"
            exit 1
          fi

      # ── Checkout ────────────────────────────────────────────────────
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ── Check for changes (nightly/RC only) ─────────────────────────
      - name: Check for changes since last publish
        if: steps.release.outputs.type != 'promote'
        id: changes
        run: |
          LAST_TAG=$(git tag -l 'v*-nightly.*' 'v*-rc.*' --sort=-version:refname | head -1)
          if [ -z "${LAST_TAG}" ]; then
            echo "No previous publish tag found, will publish"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "Comparing against ${LAST_TAG}"
          # Exclude package-npm.json from the name-only diff to avoid triggering on
          # version-bump-only changes (the promote step bumps the version field after
          # each stable release). We check it separately below for real dep changes.
          CHANGED=$(git diff --name-only "${LAST_TAG}"..HEAD -- \
            apps/daemon/ \
            packages/loro-schema/ \
            packages/session/ \
            ':!apps/daemon/package-npm.json' \
          )
          # Also trigger if package-npm.json changed in any way other than the version field.
          PKG_JSON_NONTRIVIAL=$(git diff "${LAST_TAG}"..HEAD -- apps/daemon/package-npm.json \
            | grep '^[+-]' | grep -v '^[+-][+-][+-]' | grep -v '"version"' || true)
          if [ -n "${PKG_JSON_NONTRIVIAL}" ]; then
            CHANGED="${CHANGED}"$'\n'"apps/daemon/package-npm.json (non-version change)"
          fi
          if [ -z "${CHANGED}" ]; then
            echo "No changes since ${LAST_TAG}, skipping publish"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected:"
            echo "${CHANGED}"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip if no changes
        if: steps.release.outputs.type != 'promote' && steps.changes.outputs.has_changes == 'false'
        run: |
          echo "### Skipped" >> "$GITHUB_STEP_SUMMARY"
          echo "No changes since last publish. Nothing to do." >> "$GITHUB_STEP_SUMMARY"

      # ── Setup toolchain ─────────────────────────────────────────────
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        if: steps.release.outputs.type == 'promote' || steps.changes.outputs.has_changes == 'true'
        with:
          node-version: '22.14.0'

      - name: Install npm (OIDC trusted publishing)
        if: steps.release.outputs.type == 'promote' || steps.changes.outputs.has_changes == 'true'
        run: |
          npm install -g npm@latest
          npm config set registry https://registry.npmjs.org/
          echo "npm version: $(npm --version)"

      - name: Install pnpm via corepack
        if: steps.release.outputs.type == 'promote' || steps.changes.outputs.has_changes == 'true'
        run: corepack enable && corepack install

      - uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3  # v2.1.2
        if: steps.release.outputs.type == 'promote' || steps.changes.outputs.has_changes == 'true'

      # ── Build (nightly/RC only) ─────────────────────────────────────
      - name: Install dependencies
        if: steps.release.outputs.type != 'promote' && steps.changes.outputs.has_changes == 'true'
        run: pnpm install --frozen-lockfile

      - name: Build daemon and workspace deps
        if: steps.release.outputs.type != 'promote' && steps.changes.outputs.has_changes == 'true'
        run: pnpm turbo build --filter=@shipyard/daemon

      # ── Version stamp (nightly/RC) ──────────────────────────────────
      - name: Compute version
        if: steps.release.outputs.type != 'promote' && steps.changes.outputs.has_changes == 'true'
        id: version
        env:
          RELEASE_TYPE: ${{ steps.release.outputs.type }}
        run: |
          BASE_VERSION=$(node -p "require('./apps/daemon/package-npm.json').version")
          DATE_STAMP=$(date -u +%Y%m%d)
          PREFIX="${BASE_VERSION}-${RELEASE_TYPE}.${DATE_STAMP}."

          # Verify registry is reachable before querying versions
          if ! npm view @schoolai/shipyard --json > /dev/null 2>&1; then
            echo "::error::npm registry unreachable or package not found"
            exit 1
          fi

          COUNTER=$(npm view @schoolai/shipyard versions --json 2>/dev/null | node -e "
            const prefix = process.env.PREFIX;
            let data = '';
            process.stdin.setEncoding('utf8');
            process.stdin.on('data', c => data += c);
            process.stdin.on('end', () => {
              const versions = JSON.parse(data || '[]');
              const arr = Array.isArray(versions) ? versions : (typeof versions === 'string' ? [versions] : []);
              const counters = arr
                .filter(v => typeof v === 'string' && v.startsWith(prefix))
                .map(v => Number(v.slice(prefix.length)))
                .filter(n => Number.isFinite(n) && n >= 0);
              console.log(counters.length === 0 ? 0 : Math.max(...counters) + 1);
            });
          ")

          VERSION="${BASE_VERSION}-${RELEASE_TYPE}.${DATE_STAMP}.${COUNTER}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=v${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Computed version: ${VERSION} (counter: ${COUNTER})"

      - name: Prepare npm package
        if: steps.release.outputs.type != 'promote' && steps.changes.outputs.has_changes == 'true'
        working-directory: apps/daemon
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          cp package-npm.json package.json
          npm version "${VERSION}" --no-git-tag-version --allow-same-version

      - name: Check if version already published (nightly/RC)
        if: steps.release.outputs.type != 'promote' && steps.changes.outputs.has_changes == 'true'
        id: check_published
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          if npm view "@schoolai/shipyard@${VERSION}" version > /dev/null 2>&1; then
            echo "::notice::Version ${VERSION} already exists on npm, skipping publish"
            echo "already_published=true" >> "$GITHUB_OUTPUT"
          else
            echo "already_published=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish to npm (nightly/RC)
        if: steps.release.outputs.type != 'promote' && steps.changes.outputs.has_changes == 'true' && steps.check_published.outputs.already_published != 'true'
        working-directory: apps/daemon
        run: npm publish --tag next --provenance --access public

      - name: Git tag (nightly/RC)
        if: steps.release.outputs.type != 'promote' && steps.changes.outputs.has_changes == 'true' && steps.check_published.outputs.already_published != 'true'
        env:
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${TAG}"
          git push origin "${TAG}"

      - name: GitHub pre-release (nightly/RC)
        if: steps.release.outputs.type != 'promote' && steps.changes.outputs.has_changes == 'true' && steps.check_published.outputs.already_published != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.version.outputs.tag }}
          VERSION: ${{ steps.version.outputs.version }}
          RELEASE_TYPE: ${{ steps.release.outputs.type }}
        run: |
          gh release create "${TAG}" \
            --title "${RELEASE_TYPE}: ${VERSION}" \
            --notes "Published \`@schoolai/shipyard@${VERSION}\` to npm with \`@next\` tag." \
            --prerelease

      # ── Promote to stable ───────────────────────────────────────────
      - name: Promote to stable
        if: steps.release.outputs.type == 'promote'
        id: promote
        env:
          PROMOTE_VERSION: ${{ github.event.inputs.promote_version }}
        run: |
          # Extract base version (strip prerelease suffix)
          STABLE_VERSION=$(echo "${PROMOTE_VERSION}" | sed 's/-.*//')
          echo "stable_version=${STABLE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=v${STABLE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Promoting ${PROMOTE_VERSION} -> ${STABLE_VERSION}"

          # Download the prerelease tarball
          npm pack "@schoolai/shipyard@${PROMOTE_VERSION}" --pack-destination /tmp
          TARBALL=$(ls /tmp/schoolai-shipyard-*.tgz)

          # Extract, update version, repack
          mkdir -p /tmp/promote-pkg
          tar xzf "${TARBALL}" -C /tmp/promote-pkg
          cd /tmp/promote-pkg/package
          npm version "${STABLE_VERSION}" --no-git-tag-version --allow-same-version

          # Publish as latest (skip if already published)
          if npm view "@schoolai/shipyard@${STABLE_VERSION}" version > /dev/null 2>&1; then
            echo "::notice::Version ${STABLE_VERSION} already exists on npm, skipping publish"
          else
            npm publish --tag latest --access public
          fi

      - name: Tag stable release (promote)
        if: steps.release.outputs.type == 'promote'
        env:
          TAG: ${{ steps.promote.outputs.tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f "${TAG}"
          git push --force origin "${TAG}"

      - name: Bump base version for next cycle (promote)
        if: steps.release.outputs.type == 'promote'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STABLE_VERSION: ${{ steps.promote.outputs.stable_version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          NEXT_VERSION=$(node -e "
            const [major, minor, patch] = process.env.STABLE_VERSION.split('.').map(Number);
            console.log(major + '.' + (minor + 1) + '.0');
          ")

          BRANCH="chore/bump-npm-version-to-${NEXT_VERSION}"

          git checkout -B "${BRANCH}"

          cd apps/daemon
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package-npm.json', 'utf8'));
            pkg.version = process.env.NEXT_VERSION;
            fs.writeFileSync('package-npm.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          cd ../..

          git add apps/daemon/package-npm.json
          git commit -m "chore: bump base version to ${NEXT_VERSION} for next release cycle"
          git push --force origin "${BRANCH}"

          # Create PR only if one doesn't already exist for this branch
          if ! gh pr list --head "${BRANCH}" --state open --json number --jq '.[0].number' | grep -q .; then
            gh pr create \
              --title "chore: bump npm base version to ${NEXT_VERSION}" \
              --body "Auto-generated after promoting v${STABLE_VERSION} to stable. Bumps base version for next release cycle." \
              --base main \
              --head "${BRANCH}"
          else
            echo "::notice::PR already exists for branch ${BRANCH}"
          fi

      - name: GitHub release (promote)
        if: steps.release.outputs.type == 'promote'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.promote.outputs.tag }}
          STABLE_VERSION: ${{ steps.promote.outputs.stable_version }}
          PROMOTE_VERSION: ${{ github.event.inputs.promote_version }}
        run: |
          gh release create "${TAG}" \
            --title "v${STABLE_VERSION}" \
            --notes "Promoted \`@schoolai/shipyard@${PROMOTE_VERSION}\` to stable \`@${STABLE_VERSION}\`." \
            --latest

      # ── Summary ─────────────────────────────────────────────────────
      - name: Summary
        if: always()
        env:
          RELEASE_TYPE: ${{ steps.release.outputs.type }}
          VERSION: ${{ steps.version.outputs.version }}
          STABLE_VERSION: ${{ steps.promote.outputs.stable_version }}
          PROMOTE_VERSION: ${{ github.event.inputs.promote_version }}
          HAS_CHANGES: ${{ steps.changes.outputs.has_changes }}
        run: |
          if [ "${RELEASE_TYPE}" = "promote" ]; then
            echo "### Published @schoolai/shipyard@${STABLE_VERSION} (stable)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Promoted from \`${PROMOTE_VERSION}\`" >> "$GITHUB_STEP_SUMMARY"
          elif [ "${HAS_CHANGES}" = "true" ]; then
            echo "### Published @schoolai/shipyard@${VERSION} (${RELEASE_TYPE})" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Install: \`npm install @schoolai/shipyard@next\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### Skipped (no changes)" >> "$GITHUB_STEP_SUMMARY"
          fi
