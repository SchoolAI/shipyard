# Docker Compose configuration for isolated Shipyard development
#
# Services:
#   - registry: MCP server with WebSocket sync (exposed :32191)
#   - session: WebRTC signaling + OAuth server (exposed :4444)
#   - web: Vite dev server (exposed :5173)
#   - og-proxy: OpenGraph proxy worker (internal :4446) - DISABLED
#   - daemon: Agent launcher daemon (exposed :4445)
#
# Note: OAuth is now integrated into the session server.
# The session server handles GitHub OAuth and issues Shipyard JWTs.
#
# Usage:
#   docker compose up --build           # Start all services
#   docker compose up --build registry  # Start specific service
#   pnpm dev:isolated                   # Use wrapper script (recommended)
#
# Volumes:
#   - shipyard-data: Persisted plan data (registry + daemon)
#   - daemon-logs: Claude spawn request logs
#
# Environment variables can be overridden via .env.docker file
#
# Required secrets for session server (set in .env.docker):
#   - GITHUB_CLIENT_ID: GitHub OAuth App client ID
#   - GITHUB_CLIENT_SECRET: GitHub OAuth App client secret
#   - JWT_SECRET: Secret for signing Shipyard JWTs (min 32 chars)

services:
  # ==========================================================================
  # REGISTRY - MCP Server with WebSocket sync
  # ==========================================================================
  registry:
    platform: linux/amd64
    build:
      context: .
      target: registry
    ports:
      - "${REGISTRY_PORT:-32191}:${REGISTRY_PORT:-32191}"
    environment:
      # Server configuration
      - REGISTRY_PORT=${REGISTRY_PORT:-32191}
      - SHIPYARD_STATE_DIR=/data/shipyard
      # URLs for internal service communication
      - SESSION_URL=ws://session:${SESSION_PORT:-4444}
      - SHIPYARD_WEB_URL=http://web:${VITE_PORT:-5173}
      - SERVER_PORT=${SERVER_PORT:-4445}
      # Node options
      - NODE_ENV=development
      - LOG_LEVEL=${LOG_LEVEL:-debug}
    volumes:
      # Persistent data storage
      - shipyard-data:/data/shipyard
      # Read-only access to Claude config (for MCP discovery)
      - ${HOME}/.claude/projects:/root/.claude/projects:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${REGISTRY_PORT:-32191}/registry"]
      interval: 10s
      timeout: 3s
      start_period: 5s
      retries: 3
    networks:
      - shipyard

  # ==========================================================================
  # SESSION - WebRTC signaling + OAuth server (Cloudflare Wrangler)
  # ==========================================================================
  # NOTE: Wrangler doesn't work reliably in Docker on Apple Silicon (Rosetta issues)
  # For local development, run natively: pnpm --filter @shipyard/session-server dev
  # ==========================================================================
  session:
    platform: linux/amd64
    build:
      context: .
      target: session
    ports:
      # Exposed for browser WebRTC connections and OAuth
      - "${SESSION_PORT:-4444}:${SESSION_PORT:-4444}"
    environment:
      # Wrangler dev server port
      - PORT=${SESSION_PORT:-4444}
      # Required secrets (set in .env.docker or use defaults for testing)
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - JWT_SECRET=${JWT_SECRET:-}
      # Development settings
      - NODE_ENV=development
      - LOG_LEVEL=${LOG_LEVEL:-debug}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${SESSION_PORT:-4444}/health"]
      interval: 10s
      timeout: 3s
      start_period: 10s
      retries: 3
    networks:
      - shipyard

  # ==========================================================================
  # WEB - Vite dev server with HMR
  # ==========================================================================
  web:
    platform: linux/amd64
    build:
      context: .
      target: web
    ports:
      - "${VITE_PORT:-5173}:${VITE_PORT:-5173}"
    environment:
      # Vite configuration
      - VITE_PORT=${VITE_PORT:-5173}
      # Browser-side URLs (these compile into the bundle)
      # Note: Browser uses localhost, not Docker network names
      - VITE_WEBRTC_SIGNALING=ws://localhost:${SESSION_PORT:-4444}
      # OAuth is now handled by session server (same base URL, /auth/github/callback endpoint)
      - VITE_GITHUB_OAUTH_WORKER=http://localhost:${SESSION_PORT:-4444}
      - VITE_OG_PROXY_URL=http://localhost:${OG_PROXY_PORT:-4446}
      - VITE_REGISTRY_PORT=${REGISTRY_PORT:-32191}
      - VITE_DAEMON_WS_URL=ws://localhost:${SERVER_PORT:-4445}
      - NODE_ENV=development
    depends_on:
      registry:
        condition: service_healthy
    networks:
      - shipyard

  # ==========================================================================
  # OAUTH - REMOVED: OAuth is now handled by the session server
  # The session server (apps/session-server/) handles both WebRTC signaling
  # and GitHub OAuth with Shipyard JWT issuance.
  # ==========================================================================

  # ==========================================================================
  # OG-PROXY - OpenGraph proxy worker (Cloudflare Wrangler)
  # DISABLED: Wrangler doesn't work in Docker on Apple Silicon (Rosetta issues)
  # For OG preview testing, run natively: pnpm --filter @shipyard/og-proxy-worker exec wrangler dev
  # ==========================================================================
  # og-proxy:
  #   platform: linux/amd64
  #   build:
  #     context: .
  #     target: og-proxy
  #   ports:
  #     - "${OG_PROXY_PORT:-4446}:${OG_PROXY_PORT:-4446}"
  #   environment:
  #     - OG_PROXY_PORT=${OG_PROXY_PORT:-4446}
  #     - VITE_PORT=${VITE_PORT:-5173}
  #     - NODE_ENV=development
  #     - LOG_LEVEL=${LOG_LEVEL:-debug}
  #   depends_on:
  #     - web
  #   networks:
  #     - shipyard

  # ==========================================================================
  # DAEMON - Agent launcher daemon
  # ==========================================================================
  daemon:
    platform: linux/amd64
    build:
      context: .
      target: daemon
    ports:
      - "${SERVER_PORT:-4445}:${SERVER_PORT:-4445}"
    environment:
      - SERVER_PORT=${SERVER_PORT:-4445}
      - SHIPYARD_STATE_DIR=/data/shipyard
      - SHIPYARD_WEB_URL=http://web:${VITE_PORT:-5173}
      - CLAUDE_EXECUTABLE=/usr/local/bin/claude-shim.sh
      - CLAUDE_SHIM_LOG_DIR=/var/log/shipyard
      - NODE_ENV=development
      - LOG_LEVEL=${LOG_LEVEL:-debug}
    volumes:
      # Persistent data storage (shared with registry)
      - shipyard-data:/data/shipyard
      # Read-only access to Claude config
      - ${HOME}/.claude:/root/.claude:ro
      # Claude spawn logs
      - daemon-logs:/var/log/shipyard
    depends_on:
      registry:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node.*daemon"]
      interval: 10s
      timeout: 3s
      start_period: 5s
      retries: 3
    networks:
      - shipyard

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  # Persistent storage for plans and CRDT data
  shipyard-data:
    name: shipyard-data-${COMPOSE_PROJECT_NAME:-shipyard}
  # Claude spawn request logs (for debugging)
  daemon-logs:
    name: shipyard-daemon-logs-${COMPOSE_PROJECT_NAME:-shipyard}

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  shipyard:
    name: shipyard-${COMPOSE_PROJECT_NAME:-shipyard}
